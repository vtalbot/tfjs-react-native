{"version":3,"file":"bundle_resource_io_test.js","sourceRoot":"","sources":["../src/bundle_resource_io_test.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\n\nimport \"./platform_react_native\";\n\nimport * as tf from \"@tensorflow/tfjs-core\";\n// tslint:disable-next-line: no-imports-from-dist\nimport { describeWithFlags } from \"@tensorflow/tfjs-core/dist/jasmine_util\";\n\nimport { bundleResourceIO } from \"./bundle_resource_io\";\nimport * as tfjsRn from \"./platform_react_native\";\nimport { RN_ENVS } from \"./test_env_registry\";\n\ndescribeWithFlags(\"BundleResourceIO\", RN_ENVS, () => {\n  // Test data.\n  const modelTopology1: {} = {\n    class_name: \"Sequential\",\n    keras_version: \"2.1.4\",\n    config: [\n      {\n        class_name: \"Dense\",\n        config: {\n          kernel_initializer: {\n            class_name: \"VarianceScaling\",\n            config: {\n              distribution: \"uniform\",\n              scale: 1.0,\n              seed: null,\n              mode: \"fan_avg\",\n            },\n          },\n          name: \"dense\",\n          kernel_constraint: null,\n          bias_regularizer: null,\n          bias_constraint: null,\n          dtype: \"float32\",\n          activation: \"linear\",\n          trainable: true,\n          kernel_regularizer: null,\n          bias_initializer: { class_name: \"Zeros\", config: {} },\n          units: 1,\n          batch_input_shape: [null, 3],\n          use_bias: true,\n          activity_regularizer: null,\n        },\n      },\n    ],\n    backend: \"tensorflow\",\n  };\n\n  const weightSpecs1: tf.io.WeightsManifestEntry[] = [\n    {\n      name: \"dense/kernel\",\n      shape: [3, 1],\n      dtype: \"float32\",\n    },\n    {\n      name: \"dense/bias\",\n      shape: [1],\n      dtype: \"float32\",\n    },\n  ];\n  const weightData1 = new ArrayBuffer(16);\n\n  it(\"constructs an IOHandler\", async () => {\n    const modelJson: tf.io.ModelJSON = {\n      modelTopology: modelTopology1,\n      weightsManifest: [\n        {\n          paths: [],\n          weights: weightSpecs1,\n        },\n      ],\n    };\n    const resourceId = 1;\n    const handler = bundleResourceIO(modelJson, resourceId);\n    expect(typeof handler.load).toBe(\"function\");\n    expect(typeof handler.save).toBe(\"function\");\n  });\n\n  it(\"loads model artifacts\", async () => {\n    const response = new Response(weightData1);\n    spyOn(tfjsRn, \"fetch\").and.returnValue(Promise.resolve(response));\n\n    const modelJson: tf.io.ModelJSON = {\n      modelTopology: modelTopology1,\n      weightsManifest: [\n        {\n          paths: [],\n          weights: weightSpecs1,\n        },\n      ],\n    };\n    const resourceId = 1;\n    const handler = bundleResourceIO(modelJson, resourceId);\n\n    const loaded = await handler.load();\n\n    expect(loaded.modelTopology).toEqual(modelTopology1);\n    expect(loaded.weightSpecs).toEqual(weightSpecs1);\n    expect(loaded.weightData).toEqual(weightData1);\n  });\n\n  it(\"errors on string modelJSON\", async () => {\n    const response = new Response(weightData1);\n    spyOn(tf.env().platform, \"fetch\").and.returnValue(\n      Promise.resolve(response)\n    );\n\n    const modelJson = `{\n      modelTopology: modelTopology1,\n      weightsManifest: [{\n        paths: [],\n        weights: weightSpecs1,\n      }]\n    }`;\n    const resourceId = 1;\n    expect(() =>\n      bundleResourceIO(modelJson as unknown as tf.io.ModelJSON, resourceId)\n    ).toThrow(\n      new Error(\n        \"modelJson must be a JavaScript object (and not a string).\\n\" +\n          \"Have you wrapped yor asset path in a require() statement?\"\n      )\n    );\n  });\n});\n\ndescribeWithFlags(\"BundleResourceIO Sharded\", RN_ENVS, () => {\n  // Test data.\n  const modelTopology: {} = {\n    class_name: \"Sequential\",\n    keras_version: \"2.1.4\",\n    config: [\n      {\n        class_name: \"Dense\",\n        config: {\n          kernel_initializer: {\n            class_name: \"VarianceScaling\",\n            config: {\n              distribution: \"uniform\",\n              scale: 1.0,\n              seed: null,\n              mode: \"fan_avg\",\n            },\n          },\n          name: \"dense\",\n          kernel_constraint: null,\n          bias_regularizer: null,\n          bias_constraint: null,\n          dtype: \"float32\",\n          activation: \"linear\",\n          trainable: true,\n          kernel_regularizer: null,\n          bias_initializer: { class_name: \"Zeros\", config: {} },\n          units: 1,\n          batch_input_shape: [null, 3],\n          use_bias: true,\n          activity_regularizer: null,\n        },\n      },\n      {\n        class_name: \"Dense\",\n        config: {\n          kernel_initializer: {\n            class_name: \"VarianceScaling\",\n            config: {\n              distribution: \"uniform\",\n              scale: 1.0,\n              seed: null,\n              mode: \"fan_avg\",\n            },\n          },\n          name: \"dense2\",\n          kernel_constraint: null,\n          bias_regularizer: null,\n          bias_constraint: null,\n          dtype: \"float32\",\n          activation: \"linear\",\n          trainable: true,\n          kernel_regularizer: null,\n          bias_initializer: { class_name: \"Zeros\", config: {} },\n          units: 1,\n          batch_input_shape: [null, 3],\n          use_bias: true,\n          activity_regularizer: null,\n        },\n      },\n    ],\n    backend: \"tensorflow\",\n  };\n\n  const weightSpecs: tf.io.WeightsManifestEntry[] = [\n    {\n      name: \"dense/kernel\",\n      shape: [3, 1],\n      dtype: \"float32\",\n    },\n    {\n      name: \"dense/bias\",\n      shape: [1],\n      dtype: \"float32\",\n    },\n    {\n      name: \"dense2/kernel\",\n      shape: [3, 1],\n      dtype: \"float32\",\n    },\n    {\n      name: \"dense2/bias\",\n      shape: [1],\n      dtype: \"float32\",\n    },\n  ];\n  const weightData1 = new ArrayBuffer(16);\n  const weightData2 = new ArrayBuffer(16);\n  const resourceIds = [1, 2];\n\n  const combinedWeightsExpected = new ArrayBuffer(32);\n\n  it(\"constructs an IOHandler\", async () => {\n    const modelJson: tf.io.ModelJSON = {\n      modelTopology,\n      weightsManifest: [\n        {\n          paths: [],\n          weights: weightSpecs,\n        },\n      ],\n    };\n\n    const handler = bundleResourceIO(modelJson, resourceIds);\n    expect(typeof handler.load).toBe(\"function\");\n    expect(typeof handler.save).toBe(\"function\");\n  });\n\n  it(\"loads model artifacts\", async () => {\n    spyOn(tf.env().platform, \"fetch\").and.returnValues(\n      Promise.resolve(new Response(weightData1)),\n      Promise.resolve(new Response(weightData2))\n    );\n\n    const modelJson: tf.io.ModelJSON = {\n      modelTopology,\n      weightsManifest: [\n        {\n          paths: [],\n          weights: weightSpecs,\n        },\n      ],\n    };\n\n    const handler = bundleResourceIO(modelJson, resourceIds);\n\n    const loaded = await handler.load();\n\n    expect(loaded.modelTopology).toEqual(modelTopology);\n    expect(loaded.weightSpecs).toEqual(weightSpecs);\n    expect(loaded.weightData).toEqual(combinedWeightsExpected);\n  });\n});\n"]}